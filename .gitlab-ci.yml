image: mcr.microsoft.com/playwright:v1.57.0-jammy

stages:
  - testing_suite
  - mirror

variables:
  SLACK_CHANNEL: "#_qatesting_stream"

  GIT_DEPTH: 0
  GIT_TRACE: 1

  PLAYWRIGHT_BASE_URL: https://hyva-demo.elgentos.io/
  PLAYWRIGHT_PRODUCTION_URL: https://hyva-demo.elgentos.io/
  PLAYWRIGHT_STAGING_URL: https://hyva-demo.elgentos.io/

  MAGENTO_ADMIN_SLUG: $MAGENTO_ADMIN_SLUG
  MAGENTO_ADMIN_USERNAME: $MAGENTO_ADMIN_USERNAME
  MAGENTO_ADMIN_PASSWORD: $MAGENTO_ADMIN_PASSWORD

  MAGENTO_NEW_ACCOUNT_PASSWORD: $MAGENTO_NEW_ACCOUNT_PASSWORD
  MAGENTO_EXISTING_ACCOUNT_EMAIL_CHROMIUM: $MAGENTO_EXISTING_ACCOUNT_EMAIL_CHROMIUM
  MAGENTO_EXISTING_ACCOUNT_EMAIL_FIREFOX: $MAGENTO_EXISTING_ACCOUNT_EMAIL_FIREFOX
  MAGENTO_EXISTING_ACCOUNT_EMAIL_WEBKIT: $MAGENTO_EXISTING_ACCOUNT_EMAIL_WEBKIT

  # LET OP: dit lijkt een typo in jouw config (EMAIL_PASSWORD vs ACCOUNT_PASSWORD)
  # Ik laat hem staan als drop-in, maar debug gaat dit direct onthullen.
  MAGENTO_EXISTING_ACCOUNT_PASSWORD: $MAGENTO_EXISTING_ACCOUNT_EMAIL_PASSWORD
  MAGENTO_EXISTING_ACCOUNT_CHANGED_PASSWORD: $MAGENTO_EXISTING_ACCOUNT_CHANGED_PASSWORD

  MAGENTO_COUPON_CODE_CHROMIUM: $MAGENTO_COUPON_CODE_CHROMIUM
  MAGENTO_COUPON_CODE_FIREFOX: $MAGENTO_COUPON_CODE_FIREFOX
  MAGENTO_COUPON_CODE_WEBKIT: $MAGENTO_COUPON_CODE_WEBKIT

  # Alias: API username = admin username
  MAGENTO_API_USERNAME: $MAGENTO_ADMIN_USERNAME
  MAGENTO_API_PASSWORD: $MAGENTO_API_PASSWORD

  CAPTCHA_BYPASS: "true"
  PLAYWRIGHT_BROWSERS_PATH: /ms-playwright

# -----------------------------------------
# Shared debug helpers (no secrets leakage)
# -----------------------------------------
.debug-template:
  before_script:
    - set -euo pipefail
    - echo "== CI context =="
    - echo "CI_PROJECT_PATH=${CI_PROJECT_PATH}"
    - echo "CI_PIPELINE_URL=${CI_PIPELINE_URL}"
    - echo "CI_JOB_NAME=${CI_JOB_NAME}"
    - echo "CI_COMMIT_REF_NAME=${CI_COMMIT_REF_NAME}"
    - echo "Runner: ${CI_RUNNER_DESCRIPTION:-unknown} / Executor: ${CI_RUNNER_EXECUTOR:-unknown}"
    - echo
    - echo "== System =="
    - uname -a || true
    - node -v || true
    - npm -v || true
    - npx playwright --version || true
    - echo
    - echo "== Workspace =="
    - pwd
    - ls -la
    - echo
    - echo "== Env var sanity (set/empty + length only) =="
    - |-
      check_var () {
        name="$1"
        val="${!name-}"
        if [ -z "${val}" ]; then
          echo "VAR ${name}: EMPTY"
        else
          # Print length + first/last char category hints without leaking full secret
          # (safe for passwords; still don't print actual)
          echo "VAR ${name}: SET (len=${#val})"
        fi
      }

      # URLs / non-secret
      check_var PLAYWRIGHT_BASE_URL
      check_var PLAYWRIGHT_STAGING_URL
      check_var PLAYWRIGHT_PRODUCTION_URL
      check_var CAPTCHA_BYPASS
      check_var MAGENTO_ADMIN_SLUG

      # creds/secrets - only set/len
      check_var MAGENTO_ADMIN_USERNAME
      check_var MAGENTO_ADMIN_PASSWORD
      check_var MAGENTO_API_USERNAME
      check_var MAGENTO_API_PASSWORD

      check_var MAGENTO_EXISTING_ACCOUNT_EMAIL_CHROMIUM
      check_var MAGENTO_EXISTING_ACCOUNT_EMAIL_FIREFOX
      check_var MAGENTO_EXISTING_ACCOUNT_EMAIL_WEBKIT
      check_var MAGENTO_EXISTING_ACCOUNT_PASSWORD
      check_var MAGENTO_EXISTING_ACCOUNT_CHANGED_PASSWORD

      check_var MAGENTO_COUPON_CODE_CHROMIUM
      check_var MAGENTO_COUPON_CODE_FIREFOX
      check_var MAGENTO_COUPON_CODE_WEBKIT

    - echo
    - echo "== Quick network checks (no auth) =="
    - |-
      # Basic connectivity / DNS / TLS
      echo "curl HEAD homepage:"
      curl -sS -I --max-time 15 "${PLAYWRIGHT_BASE_URL}" | head -n 20 || true
      echo
      echo "curl HEAD /rest/V1/ (Magento REST base often returns 200/403/404 depending config):"
      curl -sS -I --max-time 15 "${PLAYWRIGHT_BASE_URL%/}/rest/V1/" | head -n 20 || true
      echo
      echo "curl HEAD /admin (slug):"
      if [ -n "${MAGENTO_ADMIN_SLUG:-}" ]; then
        curl -sS -I --max-time 15 "${PLAYWRIGHT_BASE_URL%/}/${MAGENTO_ADMIN_SLUG}/" | head -n 20 || true
      else
        echo "MAGENTO_ADMIN_SLUG empty; skipping"
      fi
    - echo
    - echo "== Token probe (masked output) =="
    - |-
      # Probe the integration token endpoint. We do NOT print password; we only print status + first part of body.
      # Magento 2: POST /rest/V1/integration/admin/token with JSON: {"username":"...","password":"..."}
      # If creds wrong -> 401 with JSON message (as in your log)
      # If WAF / CF issues -> HTML 5xx page
      if [ -z "${MAGENTO_API_USERNAME:-}" ] || [ -z "${MAGENTO_API_PASSWORD:-}" ]; then
        echo "Skipping token probe: MAGENTO_API_USERNAME or MAGENTO_API_PASSWORD is empty"
      else
        TOKEN_URL="${PLAYWRIGHT_BASE_URL%/}/rest/V1/integration/admin/token"
        echo "POST ${TOKEN_URL}"
        # -D- prints headers to stdout; body captured separately
        resp_headers="$(mktemp)"
        resp_body="$(mktemp)"
        http_code="$(curl -sS --max-time 20 \
          -D "${resp_headers}" \
          -o "${resp_body}" \
          -w "%{http_code}" \
          -H "Content-Type: application/json" \
          -X POST \
          --data "{\"username\":\"${MAGENTO_API_USERNAME}\",\"password\":\"${MAGENTO_API_PASSWORD}\"}" \
          "${TOKEN_URL}" || echo "curl_failed")"
        echo "HTTP_CODE=${http_code}"
        echo "-- response headers (first 30 lines) --"
        head -n 30 "${resp_headers}" || true
        echo "-- response body (first 40 lines, sanitized) --"
        # Print only first lines; if it's JSON error, it's fine. If HTML, shows Cloudflare page.
        sed -e 's/'"${MAGENTO_API_USERNAME}"'/***USER***/g' "${resp_body}" | head -n 40 || true
        rm -f "${resp_headers}" "${resp_body}"
      fi

  after_script:
    - echo "== End of job debug =="

.slack-notification:
  after_script:
    # Slack notification
    - |-
      if [ "$CI_JOB_STATUS" = "success" ]; then
        COLOR="good"
        EMOJI=":white_check_mark:"
      elif [ "$CI_JOB_STATUS" = "failed" ]; then
        COLOR="danger"
        EMOJI=":x:"
      else
        COLOR="warning"
        EMOJI=":warning:"
      fi

      PAYLOAD=$(cat << JSON
      {
        "channel": "${SLACK_CHANNEL}",
        "attachments": [
          {
            "title": "Playwright",
            "title_link": "${CI_PIPELINE_URL}",
            "text": "${EMOJI} Status: ${CI_JOB_STATUS}\n Job: ${CI_JOB_NAME}",
            "color": "${COLOR}"
          }
        ]
      }
      JSON
      )
    - >
      curl -X POST ${SLACK_WEBHOOK}
      --header 'Content-Type: application/json; charset=utf-8'
      --data-binary "$PAYLOAD"

mirror_to_github:
  stage: mirror
  only:
    - main
  before_script:
    - mkdir -p ~/.ssh
    - printf "%s\n"  "$GIT_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.name "developer-elgentos"
    - git config --global user.email "developer@elgentos.nl"
  script:
    - git fetch origin main
    - git checkout -B main origin/main
    - git remote add github git@github.com:elgentos/magento2-playwright.git
    - git fetch github main
    - git push github main:gitlab-main

test_mirror_pipeline:
  stage: mirror
  rules:
    - if: '$CI_COMMIT_BRANCH != "main"'
  before_script:
    - mkdir -p ~/.ssh
    - printf "%s\n"  "$GIT_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.name "developer-elgentos"
    - git config --global user.email "developer@elgentos.nl"
  script:
    - git ls-remote git@github.com:elgentos/magento2-playwright.git

create_testing_suite:
  stage: testing_suite
  extends:
    - .debug-template
  script:
    - echo 'Setting up the testing environment'

    # Fix: jouw postinstall vraagt interactief om "Enter the vendor name:"
    # Dit maakt CI nondeterministisch en kan blokkeren of lege input geven.
    # We forceren een waarde via stdin.
    - mkdir -p base-tests
    - printf "elgentos\n" | npm install

    # Check what files are present
    - ls -la
    - ls -l base-tests || true

    # Extra: toon .env die gekopieerd werd (zonder secretsâ€”maar check of file bestaat)
    - echo "== .env present? =="
    - if [ -f ".env" ]; then echo ".env exists (size=$(wc -c < .env))"; else echo ".env missing"; fi

    # Run setup with full trace capture on failure
    - CI=true npx playwright test --grep "@setup" --reporter=line --workers=6 --max-failures=1 --trace=on

  allow_failure: false
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
      - base-tests/
      - tests/
      - bypass-captcha.config.ts
      - playwright.config.ts
      - tsconfig.json
      - .env

run_testing_suite:
  stage: testing_suite
  parallel: 4
  extends:
    - .debug-template
  script:
    - echo 'Running test suite'
    - printf "elgentos\n" | npm install
    - CI=true npx playwright test --workers=6 --grep-invert "@setup" --max-failures=1 --trace=retain-on-failure
  needs: [create_testing_suite]
  dependencies:
    - create_testing_suite
  allow_failure: false
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
      - .env
